<html>
<head>
    <title>Javascript client demo</title>
    <script src="js/sjcl.js"></script>
    <script src="js/nacl.min.js"></script>
    <script src="js/nacl-util.min.js"></script>
    <script src="js/lighttor.js"></script>
    <meta charset="UTF-8">
</head>
<body>
    <pre id='loaded'>Nothing to see here! </pre>
    <pre id='consensus'>Number of routers: </pre>
    <pre id='guard'>Guard identity is: </pre>
    <pre id='id'>Channel create id: </pre>
    <pre id='one'>First hop working: </pre>
    <pre id='two'>Second hop extend: </pre>
    <pre id='three'>Third hop working: </pre>
    <br>
    <pre id='log'></pre>

    <script>
        document.getElementById('loaded').innerHTML += 'Loaded!';

        var endpoint = lighttor.endpoint('localhost', 4990)
        lighttor.get.consensus(endpoint,
            function(endpoint)
            {
                var nb = endpoint.consensus.routers.length
                document.getElementById('consensus').innerHTML += nb.toString()
            })

        var cb = {
            guard: function(endpoint)
            {
                var identity = endpoint.guard.router.identity
                document.getElementById('guard').innerHTML += identity

                lighttor.post.create(endpoint, cb.create)
            },
            create: function create(endpoint)
            {
                document.getElementById('id').innerHTML += endpoint.id
                document.getElementById('one').innerHTML += 'yes'

                lighttor.io.polling(endpoint, cb.handler, cb.send, cb.error)

                lighttor.send.extend(endpoint, endpoint.path[0],
                    success=cb.extend, error=cb.error)

                endpoint.io.start()
            },
            extend: function(endpoint)
            {
                document.getElementById('two').innerHTML += 'yes'
                lighttor.send.extend(endpoint, endpoint.path[1],
                    success=cb.authority, error=cb.error)
            },
            authority: function(authority)
            {
                document.getElementById('three').innerHTML += 'yes'

                var cell = lighttor.onion.build(endpoint, 'begin_dir', 1)
                endpoint.io.send(cell)

                var cell = lighttor.onion.build(endpoint, 'data', 1,
                    nacl.util.decodeUTF8("GET /tor/server/authority HTTP/1.0\r\nAccept-Encoding: identity\r\n\r\n"))
                endpoint.io.send(cell)
            },
            send: function(endpoint)
            {
                console.log('Successfully send', endpoint.io.pending, 'cells')
            },
            handler: function(endpoint)
            {
                var cell = endpoint.io.recv()
                for (; cell !== null; cell = endpoint.io.recv())
                {
                    var cell = lighttor.onion.peel(endpoint, cell)
                    if (cell == null)
                        continue

                    if (cell.cmd == 'connected')
                        document.getElementById('log').innerHTML += (
                            'Stream connected!\n\n')

                    if (cell.cmd == 'data')
                        document.getElementById('log').innerHTML += (
                            nacl.util.encodeUTF8(cell.data))

                    if (cell.cmd == 'end')
                        document.getElementById('log').innerHTML += (
                            '\n\nStream closed!')
                }
            },
            error: function(endpoint)
            {
                console.log('Unable to interact with channel?')
            }
        }

        lighttor.get.guard(endpoint, cb.guard)
    </script>
</body>
</html>
